generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//  ************************** Eazika Database Schema **************************  //

// * =========================== Enums =========================== *

enum Role {
  user //customer
  shopkeeper
  delivery_boy
  admin
}

enum ShopCategory {
  grocery
  electronics
  furniture
  clothing
  bakery
  hmoeAppliances
  others
}

enum OrderStatus {
  pending
  confirmed
  shipped
  delivered
  cancelled
}

enum PaymentMethod {
  cash_on_delivery
  online_payment
}

enum CancelBy {
  user
  shopkeeper
  delivery_boy
  admin
}

enum ProductUnit {
  grams
  kg
  ml
  litre
  piece
}

enum DivicType {
  android
  ios
  tablet
  mobile_web
  desktop_web
  tablet_web
  other
}

// * =========================== Eazika Models =========================== *

model User {
  id               Int     @id @default(autoincrement())
  name             String
  phone            String  @unique
  email            String? @unique
  password         String?
  image            String?
  role             Role    @default(user) @map("user_role")
  isActive         Boolean @default(true) @map("is_active")
  isPhoneVerified  Boolean @default(false) @map("is_phone_verified")
  isEmailVerified  Boolean @default(false) @map("is_email_verified")
  defaultAddressId Int?    @map("default_address_id")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  address           Address[]          @relation("User_addresses")
  shopkeeper        Shopkeeper?
  deliveryBoy       DeliveryBoy?
  cartItems         CartItem[]
  orders            Order[]
  pushNotifications PushNotification[]

  @@map("users")
}

model Address {
  id          Int     @id @default(autoincrement())
  userId      Int     @map("user_id")
  name        String
  phone       String
  line1       String
  line2       String?
  street      String?
  country     String  @default("india")
  state       String  @default("maharashtra")
  city        String  @default("nagpur")
  pinCode     String  @map("pin_code")
  geoLocation String?
  isDeleted   Boolean @default(false) @map("is_deleted")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User    @relation("User_addresses", fields: [userId], references: [id])
  orders Order[]

  @@map("addresses")
}

model Shopkeeper {
  id           Int @id @default(autoincrement())
  userId       Int @unique @map("user_id")
  documentId   Int @unique @map("document_id")
  bankDetailId Int @unique @map("bank_detail_id")

  // Shop Details
  shopName      String       @map("shop_name")
  shopCategory  ShopCategory @map("shop_category")
  shopImage     String[]     @map("shop_images")
  fssaiNumber   String?      @unique @map("fssai_number")
  gstNumber     String?      @unique @map("gst_number")
  isActive      Boolean      @default(true) @map("is_active")
  deactivatedAt DateTime?    @map("deactivated_at")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User               @relation(fields: [userId], references: [id])
  document     ShopkeeperDocument @relation(fields: [documentId], references: [id])
  bankDetail   BankDetail         @relation(fields: [bankDetailId], references: [id])
  shopProducts ShopProduct[]
  deliveryBoys DeliveryBoy[]

  @@map("shopkeepers")
}

model DeliveryBoy {
  id Int @id @default(autoincrement())

  // Personal Details
  userId        Int      @unique @map("user_id")
  shopkeeperId  Int      @map("shopkeeper_id")
  aadharNumber  String   @unique @map("aadhar_number")
  panNumber     String?  @unique @map("pan_number")
  licenseNumber String   @unique @map("license_number")
  licenseImage  String[] @map("license_images")

  //  Vehicle Details
  vehicleOwnerName String  @map("vehicle_owner_name")
  vehicleName      String? @map("vehicle_name")
  vehicleNo        String  @unique @map("vehicle_no")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user       User       @relation(fields: [userId], references: [id])
  shopkeeper Shopkeeper @relation(fields: [shopkeeperId], references: [id])
  orders     Order[]

  @@map("delivery_boys")
}

model BankDetail {
  id                Int     @id @default(autoincrement())
  accountHolderName String  @map("account_holder_name")
  accountNumber     String  @map("account_number")
  ifscCode          String  @map("ifsc_code")
  bankName          String  @map("bank_name")
  branchName        String  @map("branch_name")
  bankPassbookImage String? @map("bank_passbook_image")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper Shopkeeper?

  @@map("bank_details")
}

model ShopkeeperDocument {
  id                       Int     @id @default(autoincrement())
  aadharImage              String  @map("aadhar_image")
  electricityBillImage     String  @map("electricity_bill_image")
  businessCertificateImage String  @map("business_certificate_image")
  panImage                 String? @map("pan_image")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper Shopkeeper?

  @@map("shopkeeper_documents")
}

model ProductPrice {
  id              Int         @id @default(autoincrement())
  price           Float
  discount        Float       @default(0.0)
  weight          Int
  stock           Int?
  unit            ProductUnit @default(grams)
  currency        String      @default("INR")
  globalProductId Int?
  shopProductId   Int?

  // Relations
  globalProduct GlobalProduct? @relation(fields: [globalProductId], references: [id])
  shopProduct   ShopProduct?   @relation(fields: [shopProductId], references: [id])
  cartItems     CartItem[]
  orderItems    OrderItem[]
}

model GlobalProduct {
  id                Int      @id @default(autoincrement())
  productCategoryId Int      @map("category_id")
  brand             String?
  name              String
  description       String?
  images            String[]
  priceIds          Int[]    @map("product_pricing")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  prices            ProductPrice[]
  shopProducts      ShopProduct[]
  productCategories ProductCategory @relation(fields: [productCategoryId], references: [id])

  @@map("global_products")
}

model ShopProduct {
  id                Int     @id @default(autoincrement())
  shopkeeperId      Int     @map("shopkeeper_id")
  productCategoryId Int     @map("category_id")
  globalProductId   Int?    @map("global_product_id")
  isGlobalProduct   Boolean @default(true) @map("is_global_product")

  // Product Details
  brand       String?
  name        String?
  description String?
  images      String[]
  priceIds    Int[]    @map("price_ids")
  stock       Int      @default(0)
  isActive    Boolean  @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper        Shopkeeper      @relation(fields: [shopkeeperId], references: [id])
  prices            ProductPrice[]
  globalProduct     GlobalProduct?  @relation(fields: [globalProductId], references: [id])
  cartItems         CartItem[]
  productCategories ProductCategory @relation(fields: [productCategoryId], references: [id])
  orderItems        OrderItem[]

  @@map("shop_products")
}

model ProductCategory {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  // Relations
  shopProduct   ShopProduct[]
  globalProduct GlobalProduct[]

  @@map("product_categories")
}

model CartItem {
  id             Int @id @default(autoincrement())
  userId         Int @map("user_id")
  shopProductId  Int @map("shop_product_id")
  productPriceId Int @map("product_price_id")
  quantity       Int @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User         @relation(fields: [userId], references: [id])
  shopProduct  ShopProduct  @relation(fields: [shopProductId], references: [id])
  productPrice ProductPrice @relation(fields: [productPriceId], references: [id])

  @@map("cart_items")
}

model OrderItem {
  id             Int  @id @default(autoincrement())
  shopProductId  Int  @map("shop_product_id")
  productPriceId Int  @map("product_price_id")
  quantity       Int  @default(1)
  orderId        Int?

  // Relations
  shopProduct  ShopProduct  @relation(fields: [shopProductId], references: [id])
  productPrice ProductPrice @relation(fields: [productPriceId], references: [id])
  order        Order?       @relation(fields: [orderId], references: [id])

  @@map("order_items")
}

model Order {
  id                    Int           @id @default(autoincrement())
  userId                Int           @map("user_id")
  assignedDeliveryBoyId Int?          @map("assigned_delivery_boy_id")
  totalProducts         Int           @map("total_products")
  totalAmount           Float         @map("total_amount")
  addressId             Int           @map("address_id")
  paymentMethod         PaymentMethod @map("payment_method")
  cancelBy              CancelBy?     @map("cancel_by")
  cancelReason          String?       @map("cancel_reason")
  status                OrderStatus   @default(pending) @map("order_status")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User         @relation(fields: [userId], references: [id])
  address     Address      @relation(fields: [addressId], references: [id])
  deliveryBoy DeliveryBoy? @relation(fields: [assignedDeliveryBoyId], references: [id])
  orderItems  OrderItem[]

  @@map("orders")
}

// * =========================== OTP and Notification Models =========================== *

model PhoneOtpHistory {
  id        Int      @id @default(autoincrement())
  phone     String
  otpHash   String
  requestId String   @unique @map("request_id")
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)

  @@map("phone_otp_histories")
}

model EmailOtpHistory {
  id        Int      @id @default(autoincrement())
  email     String
  otpHash   String
  requestId String   @unique @map("request_id")
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)

  @@map("email_otp_histories")
}

model PushNotification {
  id             Int       @id @default(autoincrement())
  userId         Int       @map("user_id")
  phone          String
  expirationTime DateTime? @map("expiration_time")
  endpoint       String
  authKey        String    @map("auth_key")
  p256dhKey      String    @map("p256dh_key")
  userDevice     String?   @map("user_device")
  deviceType     DivicType @default(other) @map("device_type")
  createdAt      DateTime  @default(now())

  user                      User                      @relation(fields: [id], references: [id])
  pushNotificationHistories PushNotificationHistory[]

  @@map("push_notifications")
}

model PushNotificationHistory {
  id                 Int      @id @default(autoincrement())
  pushNotificationId Int      @map("push_notification_id")
  title              String
  body               String
  url                String
  data               String?
  isRead             Boolean  @default(false) @map("is_read")
  createdAt          DateTime @default(now())

  // Relations
  pushNotification PushNotification @relation(fields: [pushNotificationId], references: [id])

  @@map("push_notification_histories")
}

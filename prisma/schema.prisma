generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//  Eazika Prisma Schema

// Enums

enum Role {
  user //customer
  shopkeeper
  delivery_boy
  admin
}

enum ShopCategory {
  grocery
  electronics
  furniture
  clothing
  bakery
  hmoeAppliances
  others
}

// Models

model User {
  id               Int     @id @default(autoincrement())
  name             String
  phone            String  @unique
  email            String? @unique
  password         String?
  image            String?
  role             Role    @default(user) @map("user_role")
  isActive         Boolean @default(true) @map("is_active")
  isPhoneVerified  Boolean @default(false) @map("is_phone_verified")
  isEmailVerified  Boolean @default(false) @map("is_email_verified")
  defaultAddressId Int?    @map("default_address_id")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  address     Address[]    @relation("User_addresses")
  shopkeeper  Shopkeeper?
  deliveryBoy DeliveryBoy?
  cartItems   CartItem[]
  orders      Order[]

  @@map("users")
}

model Address {
  id      Int     @id @default(autoincrement())
  userId  Int     @map("user_id")
  name    String
  phone   String
  line1   String
  line2   String?
  street  String?
  country String  @default("india")
  state   String  @default("maharashtra")
  city    String  @default("nagpur")
  pinCode String  @map("pin_code")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user   User    @relation("User_addresses", fields: [userId], references: [id])
  orders Order[]

  @@map("addresses")
}

model Shopkeeper {
  id           Int @id @default(autoincrement())
  userId       Int @unique @map("user_id")
  documentId   Int @unique @map("document_id")
  bankDetailId Int @unique @map("bank_detail_id")

  // Shop Details
  shopName      String       @map("shop_name")
  shopCategory  ShopCategory @map("shop_category")
  shopImage     String[]     @map("shop_images")
  fssaiNumber   String?      @unique @map("fssai_number")
  gstNumber     String?      @unique @map("gst_number")
  isActive      Boolean      @default(true) @map("is_active")
  deactivatedAt DateTime?    @map("deactivated_at")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User               @relation(fields: [userId], references: [id])
  document     ShopkeeperDocument @relation(fields: [documentId], references: [id])
  bankDetail   BankDetail         @relation(fields: [bankDetailId], references: [id])
  shopProducts ShopProduct[]

  @@map("shopkeepers")
}

model DeliveryBoy {
  id Int @id @default(autoincrement())

  // Personal Details
  userId        Int      @unique @map("user_id")
  aadharNumber  String   @unique @map("aadhar_number")
  panNumber     String?  @unique @map("pan_number")
  licenseNumber String   @unique @map("license_number")
  licenseImage  String[] @map("license_images")

  //  Vehicle Details
  vechicleOwnerName String  @map("vehicle_owner_name")
  vehicleName       String? @map("vehicle_name")
  vehicleNo         String  @unique @map("vehicle_no")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@map("delivery_boys")
}

model BankDetail {
  id                Int     @id @default(autoincrement())
  accountHolderName String  @map("account_holder_name")
  accountNumber     String  @map("account_number")
  ifscCode          String  @map("ifsc_code")
  bankName          String  @map("bank_name")
  branchName        String  @map("branch_name")
  bankPassbookImage String? @map("bank_passbook_image")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper Shopkeeper?

  @@map("bank_details")
}

model ShopkeeperDocument {
  id                       Int     @id @default(autoincrement())
  aadharImage              String  @map("aadhar_image")
  electricityBillImage     String  @map("electricity_bill_image")
  businessCertificateImage String  @map("business_certificate_image")
  panImage                 String? @map("pan_image")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper Shopkeeper?

  @@map("shopkeeper_documents")
}

enum ProductCategory {
  electronics
  clothing
  groceries
  furniture
  bakery
  homeAppliances
  others
}

model ProductPrice {
  id              Int            @id @default(autoincrement())
  basePrice       Float          @default(0.0) @map("base_price")
  weight          Int // in grams 
  discount        Float          @default(0.0)
  currency        String         @default("INR")
  globalProduct   GlobalProduct? @relation(fields: [globalProductId], references: [id])
  globalProductId Int
  shopProduct     ShopProduct    @relation(fields: [shopProductId], references: [id])
  shopProductId   Int
}

model GlobalProduct {
  id          Int             @id @default(autoincrement())
  category    ProductCategory @map("product_category")
  name        String
  description String?
  images      String[]
  priceIds    Int[]           @map("product_pricing")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  prices       ProductPrice[]
  shopProducts ShopProduct[]

  @@map("global_products")
}

model ShopProduct {
  id           Int @id @default(autoincrement())
  shopkeeperId Int @map("shopkeeper_id")

  category        ProductCategory @map("product_category")
  globalProductId Int?            @map("global_product_id")
  isGlobalProduct Boolean         @default(true) @map("is_global_product") // 
  name            String?
  description     String?
  images          String[]
  priceIds        Int[]           @map("price_ids")
  stock           Int             @default(0)
  isActive        Boolean         @default(true) @map("is_active")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  shopkeeper        Shopkeeper          @relation(fields: [shopkeeperId], references: [id])
  prices            ProductPrice[]
  globalProduct     GlobalProduct?      @relation(fields: [globalProductId], references: [id])
  cartItems         CartItem[]
  orderShopProducts OrderShopProducts[]

  @@map("shop_products")
}

model CartItem {
  id         Int @id @default(autoincrement())
  userId     Int @map("user_id")
  shopProdId Int @map("shop_product_id")
  quantity   Int @default(1)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user        User        @relation(fields: [userId], references: [id])
  shopProduct ShopProduct @relation(fields: [shopProdId], references: [id])

  @@map("cart_items")
}

enum OrderStatus {
  pending
  confirmed
  shipped
  delivered
  cancelled
}

enum PaymentMethod {
  cash_on_delivery
  online_payment
}

model Order {
  id                 Int           @id @default(autoincrement())
  userId             Int           @map("user_id")
  totalProducts      Int[]         @map("total_products")
  totalAmount        Float         @map("total_amount")
  status             OrderStatus   @default(pending) @map("order_status") // pending, confirmed, shipped, delivered, cancelled
  addressToDeliverId Int           @map("address_to_deliver_id")
  orderDeliveredAt   DateTime?     @map("order_delivered_at")
  paymentMethod      PaymentMethod @map("payment_method")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user              User                @relation(fields: [userId], references: [id])
  address           Address             @relation(fields: [addressToDeliverId], references: [id])
  // shopProducts ShopProduct[] @relation("Order_ShopProducts", references: [id])
  orderShopProducts OrderShopProducts[]

  @@map("orders")
}

model OrderShopProducts {
  orderId    Int @map("order_id")
  shopProdId Int @map("shop_product_id")
  quantity   Int @default(1)

  // Relations
  order       Order       @relation(fields: [orderId], references: [id])
  shopProduct ShopProduct @relation(fields: [shopProdId], references: [id])

  @@id([orderId, shopProdId])
  @@map("order_shop_products")
}

model PhoneOtpHistory {
  id        Int      @id @default(autoincrement())
  phone     String
  otpHash   String
  requestId String   @unique @map("request_id")
  attempts  Int      @default(0)
  createdAt DateTime @default(now())
  expiresAt DateTime
  used      Boolean  @default(false)

  @@map("phone_otp_histories")
}
